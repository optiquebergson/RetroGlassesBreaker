import React, { useState, useEffect, useRef } from 'react';

const RetroGlassesBreaker = () => {
  const canvasRef = useRef(null);
  const [gameState, setGameState] = useState('email'); // email, playing, levelComplete, gameOver, won
  const [email, setEmail] = useState('');
  const [level, setLevel] = useState(1);
  const [score, setScore] = useState(0);
  const [lives, setLives] = useState(3);
  const [emailError, setEmailError] = useState('');
  const requestRef = useRef(null);
  
  const CANVAS_WIDTH = 800;
  const CANVAS_HEIGHT = 600;
  const PADDLE_WIDTH = 100;
  const PADDLE_HEIGHT = 20;
  const BALL_SIZE = 16;
  const BRICK_COLS = 8;
  const BRICK_WIDTH = 90;
  const BRICK_HEIGHT = 30;
  const BRICK_PADDING = 5;
  const BRICK_OFFSET_TOP = 80;
  const BRICK_OFFSET_LEFT = 35;

  const LETTERS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

  const gameRef = useRef({
    paddle: { x: CANVAS_WIDTH / 2 - PADDLE_WIDTH / 2, y: CANVAS_HEIGHT - 40, width: PADDLE_WIDTH, height: PADDLE_HEIGHT },
    ball: { x: CANVAS_WIDTH / 2, y: CANVAS_HEIGHT / 2, dx: 4, dy: -4, size: BALL_SIZE },
    bricks: [],
    keys: {},
    mouseX: CANVAS_WIDTH / 2,
    ballLaunched: false
  });

  const validateEmail = (email) => {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  };

  const handleEmailSubmit = () => {
    if (!validateEmail(email)) {
      setEmailError('Veuillez entrer une adresse email valide');
      return;
    }
    setEmailError('');
    setGameState('playing');
    initGame();
  };

  const initBricks = () => {
    const bricks = [];
    const rows = 5 + level;
    for (let row = 0; row < rows; row++) {
      for (let col = 0; col < BRICK_COLS; col++) {
        const health = level === 4 ? 2 : 1;
        bricks.push({
          x: BRICK_OFFSET_LEFT + col * (BRICK_WIDTH + BRICK_PADDING),
          y: BRICK_OFFSET_TOP + row * (BRICK_HEIGHT + BRICK_PADDING),
          width: BRICK_WIDTH,
          height: BRICK_HEIGHT,
          health: health,
          maxHealth: health,
          letter: LETTERS[Math.floor(Math.random() * LETTERS.length)],
          visible: true
        });
      }
    }
    return bricks;
  };

  const initGame = () => {
    const game = gameRef.current;
    game.paddle.x = CANVAS_WIDTH / 2 - PADDLE_WIDTH / 2;
    game.ball.x = CANVAS_WIDTH / 2;
    game.ball.y = CANVAS_HEIGHT - 60;
    game.ball.dx = 4 + level * 0.5;
    game.ball.dy = -(4 + level * 0.5);
    game.bricks = initBricks();
    game.ballLaunched = false;
  };

  useEffect(() => {
    if (gameState === 'playing') {
      const canvas = canvasRef.current;
      const ctx = canvas.getContext('2d');

      const handleKeyDown = (e) => {
        gameRef.current.keys[e.key] = true;
        if (e.key === ' ' && !gameRef.current.ballLaunched) {
          gameRef.current.ballLaunched = true;
        }
      };

      const handleKeyUp = (e) => {
        gameRef.current.keys[e.key] = false;
      };

      const handleMouseMove = (e) => {
        const rect = canvas.getBoundingClientRect();
        gameRef.current.mouseX = e.clientX - rect.left;
      };

      window.addEventListener('keydown', handleKeyDown);
      window.addEventListener('keyup', handleKeyUp);
      canvas.addEventListener('mousemove', handleMouseMove);

      const gameLoop = () => {
        update();
        draw(ctx);
        requestRef.current = requestAnimationFrame(gameLoop);
      };

      gameLoop();

      return () => {
        window.removeEventListener('keydown', handleKeyDown);
        window.removeEventListener('keyup', handleKeyUp);
        canvas.removeEventListener('mousemove', handleMouseMove);
        if (requestRef.current) {
          cancelAnimationFrame(requestRef.current);
        }
      };
    }
  }, [gameState, level, lives]);

  const update = () => {
    const game = gameRef.current;
    
    // Move paddle
    if (game.keys['ArrowLeft'] && game.paddle.x > 0) {
      game.paddle.x -= 8;
    }
    if (game.keys['ArrowRight'] && game.paddle.x < CANVAS_WIDTH - game.paddle.width) {
      game.paddle.x += 8;
    }
    
    // Mouse control
    game.paddle.x = Math.max(0, Math.min(CANVAS_WIDTH - game.paddle.width, game.mouseX - game.paddle.width / 2));

    // Move ball
    if (game.ballLaunched) {
      game.ball.x += game.ball.dx;
      game.ball.y += game.ball.dy;

      // Wall collision
      if (game.ball.x <= 0 || game.ball.x >= CANVAS_WIDTH - game.ball.size) {
        game.ball.dx = -game.ball.dx;
      }
      if (game.ball.y <= 0) {
        game.ball.dy = -game.ball.dy;
      }

      // Paddle collision
      if (
        game.ball.y + game.ball.size >= game.paddle.y &&
        game.ball.y <= game.paddle.y + game.paddle.height &&
        game.ball.x + game.ball.size >= game.paddle.x &&
        game.ball.x <= game.paddle.x + game.paddle.width
      ) {
        game.ball.dy = -Math.abs(game.ball.dy);
        const hitPos = (game.ball.x - game.paddle.x) / game.paddle.width;
        game.ball.dx = (hitPos - 0.5) * 10;
      }

      // Brick collision
      game.bricks.forEach(brick => {
        if (brick.visible &&
          game.ball.x + game.ball.size > brick.x &&
          game.ball.x < brick.x + brick.width &&
          game.ball.y + game.ball.size > brick.y &&
          game.ball.y < brick.y + brick.height
        ) {
          game.ball.dy = -game.ball.dy;
          brick.health--;
          if (brick.health <= 0) {
            brick.visible = false;
            setScore(s => s + (level * 10));
          }
        }
      });

      // Ball falls
      if (game.ball.y > CANVAS_HEIGHT) {
        setLives(l => {
          const newLives = l - 1;
          if (newLives <= 0) {
            setGameState('gameOver');
          } else {
            game.ball.x = CANVAS_WIDTH / 2;
            game.ball.y = CANVAS_HEIGHT - 60;
            game.ball.dx = 4 + level * 0.5;
            game.ball.dy = -(4 + level * 0.5);
            game.ballLaunched = false;
          }
          return newLives;
        });
      }
    } else {
      // Ball follows paddle before launch
      game.ball.x = game.paddle.x + game.paddle.width / 2 - game.ball.size / 2;
    }

    // Check level complete
    if (game.bricks.every(brick => !brick.visible)) {
      if (level === 4) {
        setGameState('won');
      } else {
        setGameState('levelComplete');
      }
    }
  };

  const draw = (ctx) => {
    const game = gameRef.current;
    
    // Background - retro gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, CANVAS_HEIGHT);
    gradient.addColorStop(0, '#1a0033');
    gradient.addColorStop(1, '#0d001a');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

    // Grid effect
    ctx.strokeStyle = 'rgba(138, 43, 226, 0.1)';
    ctx.lineWidth = 1;
    for (let i = 0; i < CANVAS_WIDTH; i += 40) {
      ctx.beginPath();
      ctx.moveTo(i, 0);
      ctx.lineTo(i, CANVAS_HEIGHT);
      ctx.stroke();
    }
    for (let i = 0; i < CANVAS_HEIGHT; i += 40) {
      ctx.beginPath();
      ctx.moveTo(0, i);
      ctx.lineTo(CANVAS_WIDTH, i);
      ctx.stroke();
    }

    // Draw bricks
    game.bricks.forEach(brick => {
      if (brick.visible) {
        const healthPercent = brick.health / brick.maxHealth;
        const hue = healthPercent * 120;
        ctx.fillStyle = `hsl(${280 + hue}, 80%, 60%)`;
        ctx.fillRect(brick.x, brick.y, brick.width, brick.height);
        
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.strokeRect(brick.x, brick.y, brick.width, brick.height);
        
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 20px "Courier New", monospace';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(brick.letter, brick.x + brick.width / 2, brick.y + brick.height / 2);
      }
    });

    // Draw paddle with character
    ctx.fillStyle = '#00ff00';
    ctx.fillRect(game.paddle.x, game.paddle.y, game.paddle.width, game.paddle.height);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.strokeRect(game.paddle.x, game.paddle.y, game.paddle.width, game.paddle.height);
    
    // Simple character on paddle
    ctx.fillStyle = '#ffff00';
    ctx.beginPath();
    ctx.arc(game.paddle.x + game.paddle.width / 2, game.paddle.y - 10, 8, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.stroke();

    // Draw ball as glasses
    ctx.save();
    ctx.translate(game.ball.x + game.ball.size / 2, game.ball.y + game.ball.size / 2);
    
    // Glasses frame
    ctx.strokeStyle = '#ff00ff';
    ctx.lineWidth = 3;
    ctx.fillStyle = 'rgba(0, 255, 255, 0.3)';
    
    // Left lens
    ctx.beginPath();
    ctx.arc(-5, 0, 6, 0, Math.PI * 2);
    ctx.fill();
    ctx.stroke();
    
    // Right lens
    ctx.beginPath();
    ctx.arc(5, 0, 6, 0, Math.PI * 2);
    ctx.fill();
    ctx.stroke();
    
    // Bridge
    ctx.beginPath();
    ctx.moveTo(-1, 0);
    ctx.lineTo(1, 0);
    ctx.stroke();
    
    ctx.restore();

    // HUD
    ctx.fillStyle = '#00ffff';
    ctx.font = 'bold 20px "Courier New", monospace';
    ctx.textAlign = 'left';
    ctx.fillText(`NIVEAU: ${level}`, 20, 30);
    ctx.fillText(`SCORE: ${score}`, 20, 55);
    ctx.fillText(`VIES: ${'❤️'.repeat(lives)}`, CANVAS_WIDTH - 150, 30);

    if (!game.ballLaunched) {
      ctx.fillStyle = '#ffff00';
      ctx.font = 'bold 16px "Courier New", monospace';
      ctx.textAlign = 'center';
      ctx.fillText('ESPACE OU CLIC POUR LANCER', CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2);
    }
  };

  const nextLevel = () => {
    setLevel(l => l + 1);
    setGameState('playing');
    initGame();
  };

  const restartGame = () => {
    setLevel(1);
    setScore(0);
    setLives(3);
    setGameState('playing');
    initGame();
  };

  const handleCanvasClick = () => {
    if (gameState === 'playing' && !gameRef.current.ballLaunched) {
      gameRef.current.ballLaunched = true;
    }
  };

  return (
    <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-purple-900 via-indigo-900 to-black p-4">
      <div className="text-center">
        {gameState === 'email' && (
          <div className="bg-black border-4 border-cyan-400 p-8 rounded-lg shadow-2xl max-w-md">
            <h1 className="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500" style={{fontFamily: '"Courier New", monospace'}}>
              CASSE-LUNETTES
            </h1>
            <p className="text-cyan-300 mb-6 text-lg" style={{fontFamily: '"Courier New", monospace'}}>
              ÉDITION RÉTRO
            </p>
            <div className="space-y-4">
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleEmailSubmit()}
                placeholder="Votre email"
                className="w-full px-4 py-3 bg-purple-900 border-2 border-pink-500 text-white rounded focus:outline-none focus:border-cyan-400 text-lg"
                style={{fontFamily: '"Courier New", monospace'}}
              />
              {emailError && <p className="text-red-400 text-sm">{emailError}</p>}
              <button
                onClick={handleEmailSubmit}
                className="w-full bg-gradient-to-r from-pink-500 to-purple-600 text-white px-6 py-3 rounded font-bold text-xl hover:from-pink-600 hover:to-purple-700 transform hover:scale-105 transition-all shadow-lg"
                style={{fontFamily: '"Courier New", monospace'}}
              >
                JOUER
              </button>
            </div>
            <p className="text-gray-400 text-sm mt-4" style={{fontFamily: '"Courier New", monospace'}}>
              Termine les 4 niveaux pour gagner !
            </p>
          </div>
        )}

        {gameState === 'playing' && (
          <div>
            <canvas
              ref={canvasRef}
              width={CANVAS_WIDTH}
              height={CANVAS_HEIGHT}
              onClick={handleCanvasClick}
              className="border-4 border-cyan-400 rounded-lg shadow-2xl cursor-pointer"
            />
            <p className="text-cyan-300 mt-4 text-lg" style={{fontFamily: '"Courier New", monospace'}}>
              ← → ou SOURIS pour bouger | ESPACE pour lancer
            </p>
          </div>
        )}

        {gameState === 'levelComplete' && (
          <div className="bg-black border-4 border-green-400 p-8 rounded-lg shadow-2xl max-w-md animate-pulse">
            <h2 className="text-5xl font-bold text-green-400 mb-4" style={{fontFamily: '"Courier New", monospace'}}>
              NIVEAU {level} TERMINÉ !
            </h2>
            <p className="text-white text-2xl mb-6" style={{fontFamily: '"Courier New", monospace'}}>
              Score: {score}
            </p>
            <button
              onClick={nextLevel}
              className="bg-gradient-to-r from-green-500 to-blue-600 text-white px-8 py-4 rounded-lg font-bold text-xl hover:from-green-600 hover:to-blue-700 transform hover:scale-105 transition-all shadow-lg"
              style={{fontFamily: '"Courier New", monospace'}}
            >
              NIVEAU SUIVANT
            </button>
          </div>
        )}

        {gameState === 'gameOver' && (
          <div className="bg-black border-4 border-red-400 p-8 rounded-lg shadow-2xl max-w-md">
            <h2 className="text-5xl font-bold text-red-400 mb-4" style={{fontFamily: '"Courier New", monospace'}}>
              GAME OVER
            </h2>
            <p className="text-white text-2xl mb-2" style={{fontFamily: '"Courier New", monospace'}}>
              Niveau atteint: {level}
            </p>
            <p className="text-white text-2xl mb-6" style={{fontFamily: '"Courier New", monospace'}}>
              Score final: {score}
            </p>
            <button
              onClick={restartGame}
              className="bg-gradient-to-r from-red-500 to-orange-600 text-white px-8 py-4 rounded-lg font-bold text-xl hover:from-red-600 hover:to-orange-700 transform hover:scale-105 transition-all shadow-lg"
              style={{fontFamily: '"Courier New", monospace'}}
            >
              RÉESSAYER
            </button>
          </div>
        )}

        {gameState === 'won' && (
          <div className="bg-black border-4 border-yellow-400 p-8 rounded-lg shadow-2xl max-w-md animate-pulse">
            <h2 className="text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-pink-500 to-purple-600 mb-4" style={{fontFamily: '"Courier New", monospace'}}>
              FÉLICITATIONS !
            </h2>
            <p className="text-cyan-300 text-3xl mb-4 font-bold" style={{fontFamily: '"Courier New", monospace'}}>
              UNE SURPRISE T'ATTEND
            </p>
            <p className="text-white text-xl mb-2" style={{fontFamily: '"Courier New", monospace'}}>
              EN MAGASIN
            </p>
            <div className="bg-purple-900 border-2 border-cyan-400 p-4 rounded-lg my-6">
              <p className="text-gray-300 text-sm mb-2" style={{fontFamily: '"Courier New", monospace'}}>
                Confirmation envoyée à:
              </p>
              <p className="text-green-400 text-lg font-bold break-all" style={{fontFamily: '"Courier New", monospace'}}>
                {email}
              </p>
            </div>
            <p className="text-white text-2xl mb-6" style={{fontFamily: '"Courier New", monospace'}}>
              Score final: {score}
            </p>
            <button
              onClick={restartGame}
              className="bg-gradient-to-r from-purple-500 to-pink-600 text-white px-8 py-4 rounded-lg font-bold text-xl hover:from-purple-600 hover:to-pink-700 transform hover:scale-105 transition-all shadow-lg"
              style={{fontFamily: '"Courier New", monospace'}}
            >
              REJOUER
            </button>
          </div>
        )}
      </div>
    </div>
  );
};

export default RetroGlassesBreaker;
